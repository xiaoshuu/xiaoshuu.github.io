---
// src/pages/notes/index.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allNotes = await getCollection('notes');

// --- ğŸ¨ è«å…°è¿ªè‰²ç³»é…ç½® ---
const morandiColors = [
  '#E0E5DF', // ç°ç»¿
  '#E4D4C8', // æš–æ²™
  '#D3C4BD', // ç°ç²‰
  '#C7CFD1', // é›¾éœ¾è“
  '#D8D3CD', // å¥¶å’–
  '#CCD4D9', // çƒŸç°è“
];

function getColor(name) {
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  const index = Math.abs(hash) % morandiColors.length;
  return morandiColors[index];
}

// --- ğŸ”§ ä¿®å¤ç‰ˆï¼šå†…å®¹æ¸…æ´—é€»è¾‘ ---
function stripMarkdown(text) {
  if (!text) return '';
  
  const commentRegex = new RegExp('', 'g');
  const htmlTagRegex = new RegExp('<[^>]+>', 'g');
  const imageRegex = new RegExp('!\\[[^\\]]*\\]\\([^)]*\\)', 'g');
  const linkRegex = new RegExp('\\[([^\\]]+)\\]\\([^)]*\\)', 'g');
  const titleRegex = new RegExp('^#+\\s+', 'gm');
  const symbolRegex = new RegExp('[*_`~>]', 'g');

  return text
    .replace(commentRegex, '')
    .replace(htmlTagRegex, '')
    .replace(imageRegex, '')
    .replace(linkRegex, '$1')
    .replace(titleRegex, '')
    .replace(symbolRegex, '')
    .replace(/\n/g, ' ') 
    .replace(/\s+/g, ' ') 
    .trim();
}

function extractDescription(post) {
  // 1. ä¼˜å…ˆä½¿ç”¨ frontmatter é‡Œçš„ description
  if (post.data.description) return post.data.description;
  if (!post.body) return '';

  let rawContent = '';
  let body = post.body;
  
  // --- ğŸ¥Š å…³é”®ä¿®å¤ï¼šæŠŠè¿™ä¸€è¡Œä»æ³¨é‡Šé‡Œæ”¾å‡ºæ¥ï¼ ---
  const moreTag = '<' + '!' + '-' + '-' + 'more' + '-' + '-' + '>';
  
  // æŸ¥æ‰¾ä½ç½®
  let splitIndex = body.indexOf(moreTag);
  
  if (splitIndex !== -1) {
    // æ‰¾åˆ°äº†ï¼æˆªå–å‰é¢çš„éƒ¨åˆ†
    rawContent = body.substring(0, splitIndex);
  } else {
    // æ²¡æ‰¾åˆ°ï¼Œå–å‰ 120 ä¸ªå­—ç¬¦
    rawContent = body.substring(0, 120);
  }

  // æ¸…æ´—
  const cleanDesc = stripMarkdown(rawContent);

  // é•¿åº¦æ§åˆ¶
  return cleanDesc.length > 100 ? cleanDesc.substring(0, 100) + '...' : cleanDesc;
}


// --- æ•°æ®å¤„ç† ---
const folderMap = new Map();
allNotes.forEach(note => {
  const slugParts = note.slug.split('/');
  const folderName = slugParts.length > 1 ? slugParts[0] : 'General';
  if (!folderMap.has(folderName)) folderMap.set(folderName, []);
  folderMap.get(folderName).push(note);
});

const folders = Array.from(folderMap.entries()).map(([name, notes]) => ({ 
  name, 
  notes: notes.sort((a, b) => (new Date(b.data.date || 0).valueOf()) - (new Date(a.data.date || 0).valueOf())) 
}));
---

<BaseLayout title="Library">
  <div class="library-container">
    
    <nav class="top-nav">
      <a href="/" class="back-btn">â† Home</a>
    </nav>

    <header class="lib-header">
      <h1 class="title">Library.</h1>
      <p class="subtitle">Structured notes & archives.</p>
    </header>

    <div class="folder-grid">
      {folders.map(folder => {
        const themeColor = getColor(folder.name);
        
        return (
          <div class="folder-card">
            
            <div class="card-header" style={`background-color: ${themeColor}`}>
              <a href={`/notes/folder/${folder.name}`} class="folder-title-link">
                <span class="folder-label">COLLECTION</span>
                <h2>{folder.name}</h2>
              </a>
              <span class="badge">{folder.notes.length}</span>
            </div>

            <div class="card-body">
              {folder.notes.slice(0, 3).map(note => (
                <a href={`/notes/${note.slug}`} class="mini-post-item">
                  <div class="post-text">
                    <span class="post-title">{note.data.title}</span>
                    <span class="post-desc">{extractDescription(note)}</span>
                  </div>
                </a>
              ))}
              
              {folder.notes.length === 0 && <div class="empty-state">Empty</div>}
            </div>

            {folder.notes.length > 3 && (
              <a href={`/notes/folder/${folder.name}`} class="card-footer">
                View all {folder.notes.length} notes â†’
              </a>
            )}
          </div>
        )
      })}
    </div>

  </div>
</BaseLayout>

<style>
  .library-container { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
  
  /* é¡¶éƒ¨å¯¼èˆª & è¿”å›æŒ‰é’® */
  .top-nav { margin-bottom: 2rem; }
  .back-btn {
    display: inline-block;
    padding: 8px 16px;
    background: #f4f4f5;
    color: #666;
    border-radius: 20px;
    text-decoration: none;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s;
  }
  .back-btn:hover { background: #e4e4e7; color: #333; }

  /* æ ‡é¢˜åŒºåŸŸ */
  .lib-header { margin-bottom: 4rem; text-align: center; }
  .title { font-family: 'Playfair Display', serif; font-size: 3.5rem; margin: 0; color: #333; letter-spacing: -1px; }
  .subtitle { color: #999; font-size: 1.1rem; margin-top: 0.5rem; font-weight: 300; }

  /* ç½‘æ ¼å¸ƒå±€ */
  .folder-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2.5rem;
  }

  /* å¡ç‰‡ä¸»ä½“ */
  .folder-card {
    background: #fff;
    border-radius: 20px;
    border: 1px solid rgba(0,0,0,0.04);
    box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  
  .folder-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 30px rgba(0,0,0,0.08);
  }

  /* å¡ç‰‡å¤´éƒ¨ï¼šå½©è‰²åŒºåŸŸ */
  .card-header {
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }
  
  .folder-title-link { text-decoration: none; color: #333; display: flex; flex-direction: column; gap: 4px; }
  .folder-label { font-size: 0.7rem; opacity: 0.6; letter-spacing: 1.5px; font-weight: 600; text-transform: uppercase; }
  .folder-title-link h2 { margin: 0; font-size: 1.4rem; text-transform: capitalize; font-weight: 700; line-height: 1.2; }
  
  .badge { 
    background: rgba(255,255,255,0.6); 
    backdrop-filter: blur(4px);
    padding: 4px 10px; 
    border-radius: 12px; 
    font-size: 0.8rem; 
    color: #444; 
    font-weight: 600; 
  }

  /* åˆ—è¡¨åŒºåŸŸ */
  .card-body { padding: 1rem 0; flex: 1; display: flex; flex-direction: column; }

  .mini-post-item {
    padding: 1rem 1.5rem;
    text-decoration: none;
    border-bottom: 1px dashed rgba(0,0,0,0.05);
    transition: background 0.1s;
  }
  .mini-post-item:last-child { border-bottom: none; }
  .mini-post-item:hover { background: #fafafa; }
  
  .post-text { display: flex; flex-direction: column; gap: 4px; }
  .post-title { color: #333; font-size: 0.95rem; font-weight: 600; }
  .post-desc { 
    color: #888; 
    font-size: 0.8rem; 
    line-height: 1.5;
    /* é™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ */
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .empty-state { padding: 2rem; color: #ccc; text-align: center; font-style: italic; font-size: 0.9rem; }

  /* åº•éƒ¨é“¾æ¥ */
  .card-footer {
    display: block;
    text-align: center;
    padding: 1rem;
    font-size: 0.85rem;
    color: #666;
    background: #fbfbfb;
    text-decoration: none;
    font-weight: 500;
    border-top: 1px solid rgba(0,0,0,0.05);
    transition: all 0.2s;
  }
  .card-footer:hover { color: #000; background: #f4f4f4; }
</style>