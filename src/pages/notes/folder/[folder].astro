---
// src/pages/notes/folder/[folder].astro
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allNotes = await getCollection('notes');
  const folders = new Set(allNotes.map(note => note.slug.split('/')[0]));
  return [...folders].map(folder => {
    const notesInFolder = allNotes.filter(note => note.slug.startsWith(folder + '/'));
    return {
      params: { folder },
      props: { notes: notesInFolder, folderName: folder }
    };
  });
}

const { notes, folderName } = Astro.props;

// --- ğŸ¨ 1. è«å…°è¿ªè‰²ç³»é…ç½® (ä¿æŒä¸€è‡´) ---
const morandiColors = [
  '#E0E5DF', // ç°ç»¿
  '#E4D4C8', // æš–æ²™
  '#D3C4BD', // ç°ç²‰
  '#C7CFD1', // é›¾éœ¾è“
  '#D8D3CD', // å¥¶å’–
  '#CCD4D9', // çƒŸç°è“
];

// æ ¹æ®æ–‡ä»¶å¤¹åç®—é¢œè‰²
const colorIndex = folderName.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % morandiColors.length;
const themeColor = morandiColors[colorIndex];


// --- ğŸ”§ 2. æ ¸å¿ƒä¿®å¤ï¼šç§»æ¤æœ€å¼ºçš„æŠ“å–é€»è¾‘ ---

function stripMarkdown(text) {
  if (!text) return '';
  
  // ä½¿ç”¨ new RegExp é¿å…è¯­æ³•é”™è¯¯
  const commentRegex = new RegExp('', 'g');
  const htmlTagRegex = new RegExp('<[^>]+>', 'g');
  const imageRegex = new RegExp('!\\[[^\\]]*\\]\\([^)]*\\)', 'g');
  const linkRegex = new RegExp('\\[([^\\]]+)\\]\\([^)]*\\)', 'g');
  const titleRegex = new RegExp('^#+\\s+', 'gm');
  const symbolRegex = new RegExp('[*_`~>]', 'g');

  return text
    .replace(commentRegex, '')
    .replace(htmlTagRegex, '')
    .replace(imageRegex, '')
    .replace(linkRegex, '$1')
    .replace(titleRegex, '')
    .replace(symbolRegex, '')
    .replace(/\n/g, ' ') 
    .replace(/\s+/g, ' ') 
    .trim();
}

function extractDescription(note) {
  // 1. ä¼˜å…ˆä½¿ç”¨ frontmatter é‡Œçš„ description
  if (note.data.description) return note.data.description;
  if (!note.body) return '';

  let rawContent = '';
  let body = note.body;
  
  // --- ğŸ¥Š å…³é”®ï¼šæŠŠè¿™ä¸€è¡Œæ”¾å‡ºæ¥ï¼Œåˆ«æ³¨é‡Šæ‰ï¼ ---
  const moreTag = '<' + '!' + '-' + '-' + 'more' + '-' + '-' + '>';
  
  // æŸ¥æ‰¾ä½ç½®
  let splitIndex = body.indexOf(moreTag);
  
  if (splitIndex !== -1) {
    // æ‰¾åˆ°äº†ï¼æˆªå–å‰é¢çš„éƒ¨åˆ†
    rawContent = body.substring(0, splitIndex);
  } else {
    // æ²¡æ‰¾åˆ°ï¼Œå–å‰ 120 ä¸ªå­—ç¬¦
    rawContent = body.substring(0, 120);
  }

  // æ¸…æ´—
  const cleanDesc = stripMarkdown(rawContent);

  // é•¿åº¦æ§åˆ¶ (è¿™é‡Œç»™ç¨å¾®çŸ­ä¸€ç‚¹ï¼Œ80å­—ï¼Œä¿æŒå¡ç‰‡æ¸…çˆ½)
  return cleanDesc.length > 80 ? cleanDesc.substring(0, 80) + '...' : cleanDesc;
}
---

<BaseLayout title={`Folder: ${folderName}`}>
  <div class="folder-page">
    
    <header class="header" style={`background-color: ${themeColor}`}>
      <div class="header-inner">
        <a href="/notes" class="back-link">â† Library</a>
        <div class="title-group">
          <span class="folder-label">COLLECTION</span>
          <h1>{folderName}</h1>
        </div>
      </div>
    </header>

    <div class="note-list">
      {notes.map(note => {
        // ä½¿ç”¨æ–°å‡½æ•°æŠ“å–æè¿°
        const desc = extractDescription(note);
        const dateStr = note.data.date ? new Date(note.data.date).toLocaleDateString() : '';

        return (
          <a href={`/notes/${note.slug}`} class="note-card">
            <div class="note-main">
              <h3>{note.data.title}</h3>
              
              {desc && <p class="desc">{desc}</p>}
              
              <div class="note-meta">
                {dateStr && <span class="date">{dateStr}</span>}
                {note.data.tags && (
                  <div class="tags">
                    {note.data.tags.map(t => <span class="tag">#{t}</span>)}
                  </div>
                )}
              </div>
            </div>
            
            <div class="arrow" style={`color: ${themeColor}; filter: brightness(0.6);`}>â†’</div>
          </a>
        );
      })}
    </div>

  </div>
</BaseLayout>

<style>
  /* é¡µé¢å®¹å™¨ */
  .folder-page { max-width: 900px; margin: 0 auto; padding-bottom: 4rem; }
  
  /* å¤´éƒ¨è®¾è®¡ï¼šå¤§è‰²å—å¡ç‰‡ */
  .header {
    /* è¿™é‡Œçš„èƒŒæ™¯è‰²ç”±ä¸Šé¢ JS åŠ¨æ€æ§åˆ¶ */
    padding: 3rem 2rem;
    border-radius: 0 0 24px 24px; /* ä¸‹æ–¹åœ†è§’ */
    margin-bottom: 3rem;
    color: #444;
  }
  .header-inner { max-width: 800px; margin: 0 auto; }

  .back-link {
    display: inline-block;
    font-size: 0.85rem;
    text-decoration: none;
    color: rgba(0,0,0,0.6);
    margin-bottom: 1.5rem;
    font-weight: 600;
    transition: opacity 0.2s;
  }
  .back-link:hover { opacity: 0.7; }

  .title-group { display: flex; flex-direction: column; gap: 0.5rem; }
  .folder-label { 
    font-family: monospace; 
    font-size: 0.8rem; 
    letter-spacing: 2px; 
    opacity: 0.6; 
    text-transform: uppercase; 
  }
  .header h1 { 
    font-family: 'Playfair Display', serif; 
    font-size: 3rem; 
    margin: 0; 
    text-transform: capitalize; 
    color: #333; 
    line-height: 1.1;
  }

  /* åˆ—è¡¨åŒºåŸŸ */
  .note-list { 
    display: flex; 
    flex-direction: column; 
    gap: 1.5rem; 
    padding: 0 1.5rem; /* å·¦å³ç•™ç™½ */
  }

  /* ç¬”è®°å¡ç‰‡ */
  .note-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #fff;
    padding: 2rem;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,0.03); /* æç»†çš„è¾¹æ¡† */
    box-shadow: 0 4px 20px rgba(0,0,0,0.02);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .note-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.06);
  }

  .note-main { flex: 1; min-width: 0; padding-right: 1rem; }
  
  .note-card h3 { 
    margin: 0 0 0.8rem 0; 
    font-size: 1.25rem; 
    font-weight: 600; 
    color: #333; 
  }

  .desc { 
    margin: 0 0 1.2rem 0; 
    color: #777; 
    font-size: 0.95rem; 
    line-height: 1.6; 
    /* é™åˆ¶è¡Œæ•° */
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical; 
    overflow: hidden;
  }

  .note-meta { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
  .date { font-family: monospace; font-size: 0.85rem; color: #aaa; }
  
  .tags { display: flex; gap: 8px; }
  .tag { 
    font-size: 0.75rem; 
    color: #666; 
    background: #f4f4f4; 
    padding: 3px 8px; 
    border-radius: 4px; 
  }

  .arrow { font-size: 1.5rem; transition: transform 0.2s; }
  .note-card:hover .arrow { transform: translateX(5px); }

  @media (max-width: 600px) {
    .header { padding: 2rem 1.5rem; border-radius: 0 0 16px 16px; }
    .header h1 { font-size: 2.2rem; }
    .note-card { padding: 1.5rem; }
    .arrow { display: none; }
  }
</style>