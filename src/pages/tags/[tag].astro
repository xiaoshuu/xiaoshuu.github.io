---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

// 1. 生成所有可能的标签路径
export async function getStaticPaths() {
  const allNotes = await getCollection('notes');
  const allThoughts = await getCollection('thoughts');
  const allTips = await getCollection('tips');
  
  const allPosts = [...allNotes, ...allThoughts, ...allTips];
  
  // 提取所有不重复的标签
  const uniqueTags = [...new Set(allPosts.flatMap(post => post.data.tags || []))];

  return uniqueTags.map(tag => {
    // 过滤出包含当前标签的文章
    const filteredPosts = allPosts.filter(post => 
      post.data.tags && post.data.tags.includes(tag)
    );
    return {
      params: { tag },
      props: { posts: filteredPosts },
    };
  });
}

const { tag } = Astro.params;
const { posts } = Astro.props;
---

<BaseLayout title={`Tag: ${tag}`}>
  <div class="tag-page-container">
    <header class="tag-header">
      <a href="/" class="back-link">← Home</a>
      <h1>Topic: <span class="highlight">#{tag}</span></h1>
      <p>{posts.length} posts found</p>
    </header>

    <div class="post-list">
      {posts.map(post => (
        <a href={`/${post.collection}/${post.slug}`} class="clean-card post-item">
          <span class="collection-badge">{post.collection}</span>
          <div class="post-info">
            <h3>{post.data.title}</h3>
            {post.data.description && <p>{post.data.description}</p>}
          </div>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>

<style>
  .tag-page-container { max-width: 800px; margin: 0 auto; padding: 4rem 1.5rem; }
  .tag-header { margin-bottom: 3rem; }
  .back-link { color: #888; font-size: 0.9rem; text-decoration: none; }
  .tag-header h1 { font-family: 'Playfair Display', serif; font-size: 2.5rem; margin: 0.5rem 0; }
  .highlight { color: var(--accent-library); }
  
  .post-list { display: flex; flex-direction: column; gap: 1rem; }
  .post-item { 
    padding: 1.5rem; 
    text-decoration: none; 
    color: inherit; 
    display: flex; 
    align-items: center; 
    gap: 1.5rem;
    transition: transform 0.2s;
  }
  .post-item:hover { transform: translateX(5px); border-color: #ccc; }
  
  .collection-badge { 
    font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
    background: #f0f0f0; padding: 4px 8px; border-radius: 4px; color: #666;
  }
  .post-info h3 { margin: 0 0 0.5rem 0; font-size: 1.1rem; }
  .post-info p { margin: 0; color: #888; font-size: 0.9rem; }
</style>